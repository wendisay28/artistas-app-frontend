import { useState, useEffect, useCallback } from 'react';
// Asumiendo que usas una instancia configurada de API o variable de entorno
// import { API_URL } from '@/config'; 

import { useAuth } from '../../../hooks/useAuth';

// ... (Las interfaces Artist, Event, Site, Product se mantienen igual)

interface FavoritesData {
  artists: any[];
  events: any[];
  sites: any[];
  gallery: any[];
  loading: boolean;
  error: string | null;
}

export const useFavoritesData = () => {
  const { user, token } = useAuth(); // En móvil solemos necesitar el token explícito para el Header
  const [data, setData] = useState<FavoritesData>({
    artists: [],
    events: [],
    sites: [],
    gallery: [],
    loading: true,
    error: null,
  });

  // Usamos useCallback para poder exponer la función de "refresh" (útil para Pull-to-Refresh)
  const fetchFavoritesData = useCallback(async () => {
    if (!user?.id) return;

    try {
      setData((prev: FavoritesData) => ({
        ...prev,
        loading: true,
        error: null,
      }));

      // IMPORTANTE: En RN usa la URL completa. 
      // Si usas Android Emulator, localhost suele ser 10.0.2.2
      const BASE_URL = 'https://tu-api-dominio.com/api'; 
      
      const headers = {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`, // Ejemplo de auth común en móvil
      };

      const [artistsRes, eventsRes, sitesRes, galleryRes] = await Promise.all([
        fetch(`${BASE_URL}/favorites/artists`),
        fetch(`${BASE_URL}/favorites/events`),
        fetch(`${BASE_URL}/favorites/sites`),
        fetch(`${BASE_URL}/favorites/gallery`),
      ]);

      // Validamos que todas las respuestas sean exitosas
      if (![artistsRes, eventsRes, sitesRes, galleryRes].every(res => res.ok)) {
        throw new Error('Error al sincronizar tus favoritos');
      }

      const [artists, events, sites, gallery] = await Promise.all([
        artistsRes.json(),
        eventsRes.json(),
        sitesRes.json(),
        galleryRes.json(),
      ]);

      setData({
        artists: artists || [],
        events: events || [],
        sites: sites || [],
        gallery: gallery || [],
        loading: false,
        error: null,
      });
    } catch (error) {
      console.error('Error loading favorites:', error);
      setData((prev: FavoritesData) => ({
        ...prev,
        loading: false,
        error: error instanceof Error ? error.message : 'Error de conexión',
      }));
    }
  }, [user?.id, token]);

  useEffect(() => {
    fetchFavoritesData();
  }, [fetchFavoritesData]);

  // Retornamos también la función refresh para el componente visual
  return { ...data, refresh: fetchFavoritesData };
};